<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºì‹œí”Œë¡œìš° ìì‚°ê´€ë¦¬ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --rat-green: #10b981;
            --fast-blue: #3b82f6;
            --gold: #fbbf24;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .glow-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .glow-gold {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .token {
            transition: all 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .bounce { animation: bounce 0.5s; }
        .celebrate { animation: celebrate 0.5s ease-in-out infinite; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .float { animation: float 3s ease-in-out infinite; }

        .dice {
            font-size: 3rem;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .dice:hover { transform: scale(1.1); }
        .dice.rolling { animation: roll 0.1s linear infinite; }

        @keyframes roll {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .track-space {
            cursor: pointer;
            transition: all 0.2s;
        }

        .track-space:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .player-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .asset-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .asset-item:hover {
            transform: translateX(5px);
            background: rgba(255,255,255,0.1);
        }

        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }

        .player-tab {
            transition: all 0.2s;
        }

        .player-tab.active {
            transform: scale(1.05);
        }
    </style>
</head>

<body class="text-white p-4">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header with Current Player Indicator -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-emerald-400 via-blue-500 to-purple-500 bg-clip-text text-transparent">
                ğŸ’° ìºì‹œí”Œë¡œìš° ìì‚°ê´€ë¦¬</h1>
            
            <!-- Current Player Display -->
            <div id="currentPlayerDisplay" class="player-indicator card rounded-xl px-4 py-2 flex items-center gap-3">
                <span class="text-2xl" id="currentPlayerEmoji">ğŸ­</span>
                <div>
                    <div class="text-sm text-gray-400">í˜„ì¬ í”Œë ˆì´ì–´</div>
                    <div class="font-bold" id="currentPlayerName">í”Œë ˆì´ì–´ 1</div>
                    <div class="text-xs text-gray-400" id="currentPlayerJob">ì§ì—… ë¯¸ì„ íƒ</div>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="resetGame()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition hover:scale-105">ğŸ”„ ë¦¬ì…‹</button>
                <button onclick="saveGame()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg transition hover:scale-105">ğŸ’¾ ì €ì¥</button>
                <button onclick="loadGame()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition hover:scale-105">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="showSetupModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition hover:scale-105">âš™ï¸ ì„¤ì •</button>
            </div>
        </header>

        <!-- Player Tabs (for multiplayer) -->
        <div id="playerTabs" class="flex gap-2 mb-4 overflow-x-auto pb-2 hidden">
        </div>

        <!-- Financial Status Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div onclick="showDetailModal('cash')" class="card rounded-xl p-3 border-l-4 border-emerald-500 cursor-pointer hover:scale-105 transition">
                <div class="text-xs text-gray-400">ğŸ’µ í˜„ê¸ˆ</div>
                <div id="dashCash" class="text-lg font-bold text-emerald-400">â‚©0</div>
            </div>
            <div onclick="showDetailModal('assets')" class="card rounded-xl p-3 border-l-4 border-blue-500 cursor-pointer hover:scale-105 transition">
                <div class="text-xs text-gray-400">ğŸ“Š ì´ ìì‚° <span class="text-[10px]">â–¼</span></div>
                <div id="dashAssets" class="text-lg font-bold text-blue-400">â‚©0</div>
            </div>
            <div onclick="showDetailModal('liabilities')" class="card rounded-xl p-3 border-l-4 border-orange-500 cursor-pointer hover:scale-105 transition">
                <div class="text-xs text-gray-400">ğŸ“‰ ì´ ë¶€ì±„ <span class="text-[10px]">â–¼</span></div>
                <div id="dashDebt" class="text-lg font-bold text-orange-400">â‚©0</div>
            </div>
            <div class="card rounded-xl p-3 border-l-4 border-purple-500">
                <div class="text-xs text-gray-400">ğŸ’° ìˆœìì‚°</div>
                <div id="dashNetWorth" class="text-lg font-bold text-purple-400">â‚©0</div>
            </div>
            <div class="card rounded-xl p-3 border-l-4 border-yellow-500">
                <div class="text-xs text-gray-400">ğŸ’¸ ì›” ìºì‹œí”Œë¡œìš°</div>
                <div id="dashCashflow" class="text-lg font-bold text-yellow-400">â‚©0</div>
            </div>
        </div>

        <!-- Detail Modal for Assets/Liabilities -->
        <div id="detailModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
            <div class="card rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="detailModalTitle" class="text-xl font-bold">ìƒì„¸ ì •ë³´</h2>
                    <button onclick="hideDetailModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="detailModalContent"></div>
            </div>
        </div>

        <!-- Asset Price Chart Modal -->
        <div id="assetChartModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
            <div class="card rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="assetChartTitle" class="text-xl font-bold">ìì‚° ê°€ê²© ì°¨íŠ¸</h2>
                    <button onclick="hideAssetChartModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <span id="assetCurrentPrice" class="text-2xl font-bold"></span>
                        <span id="assetPriceChange" class="text-lg"></span>
                    </div>
                </div>
                <canvas id="assetPriceChart" height="300"></canvas>
                <div class="mt-4 text-sm text-gray-400 text-center">ìµœê·¼ 30í„´ ê°€ê²© ë³€ë™</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Game Board -->
            <div class="lg:col-span-2 card rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ğŸ® ê²Œì„íŒ</h2>
                    <span class="text-sm">í„´: <span id="turnCount" class="font-bold text-yellow-400">1</span></span>
                </div>
                <div class="text-center mb-4">
                    <button onclick="rollDice()" id="diceBtn" class="px-8 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 rounded-2xl shadow-lg hover:shadow-yellow-500/30 transition-all hover:scale-105">
                        <span id="dice" class="text-5xl">ğŸ²</span>
                        <div class="text-black font-bold mt-1">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</div>
                    </button>
                </div>
                <svg id="gameBoard" viewBox="0 0 560 560" class="w-full max-w-2xl mx-auto"></svg>
                <div id="eventCard" class="hidden mt-4 p-4 card rounded-xl border-2 border-yellow-400">
                    <h3 class="font-bold text-lg mb-2" id="eventTitle"></h3>
                    <p id="eventDesc" class="text-gray-300 mb-3"></p>
                    <div id="priceChangeInfo" class="hidden mb-3 p-3 bg-gray-800 rounded-lg text-sm"></div>
                    <button onclick="handleEvent()" class="w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg">í™•ì¸</button>
                </div>
            </div>

            <!-- Financial Statement -->
            <div class="space-y-4">
                <!-- Income Statement -->
                <div class="card rounded-2xl p-4 glow-green">
                    <h3 class="font-bold text-emerald-400 mb-3">ğŸ“Š ì†ìµê³„ì‚°ì„œ</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>ê·¼ë¡œì†Œë“</span><span id="incSalary" class="text-emerald-400">â‚©0</span></div>
                        <div class="flex justify-between"><span>íŒ¨ì‹œë¸Œì†Œë“</span><span id="incPassive" class="text-emerald-400">â‚©0</span></div>
                        <div class="border-t border-gray-600 my-2"></div>
                        <div class="flex justify-between"><span>ì´ ì§€ì¶œ</span><span id="expTotal" class="text-red-400">â‚©0</span></div>
                        <div class="border-t border-gray-600 my-2"></div>
                        <div class="flex justify-between font-bold text-lg"><span>ì›” ìºì‹œí”Œë¡œìš°</span><span id="cashflow" class="text-yellow-400">â‚©0</span></div>
                    </div>
                </div>

                <!-- Balance Sheet -->
                <div class="card rounded-2xl p-4">
                    <h3 class="font-bold text-blue-400 mb-3">ğŸ“ˆ ëŒ€ì°¨ëŒ€ì¡°í‘œ</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>ì´ ìì‚°</span><span id="totalAssets" class="text-blue-400">â‚©0</span></div>
                        <div class="flex justify-between"><span>ì´ ë¶€ì±„</span><span id="totalLiabilities" class="text-red-400">â‚©0</span></div>
                        <div class="border-t border-gray-600 my-2"></div>
                        <div class="flex justify-between font-bold"><span>ìˆœìì‚°</span><span id="netWorth">â‚©0</span></div>
                    </div>
                    
                    <!-- Asset/Liability Summary List -->
                    <div class="mt-4 pt-4 border-t border-gray-600">
                        <h4 class="text-xs text-gray-400 mb-2">ìì‚° ìƒì„¸</h4>
                        <div id="assetSummaryList" class="space-y-1 text-xs"></div>
                        <h4 class="text-xs text-gray-400 mb-2 mt-3">ë¶€ì±„ ìƒì„¸</h4>
                        <div id="liabilitySummaryList" class="space-y-1 text-xs"></div>
                    </div>
                </div>

                <!-- Escape Progress -->
                <div class="card rounded-2xl p-4 glow-gold">
                    <h3 class="font-bold text-yellow-400 mb-3">ğŸƒ íƒˆì¶œ ì§„í–‰ë„</h3>
                    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div id="escapeProgress" class="h-full bg-gradient-to-r from-emerald-500 to-yellow-400 transition-all" style="width: 0%"></div>
                    </div>
                    <p class="text-sm mt-2 text-gray-400">íŒ¨ì‹œë¸Œ ì†Œë“ â‰¥ ì´ ì§€ì¶œ ì‹œ íƒˆì¶œ!</p>
                </div>
            </div>
        </div>

        <!-- Bottom Tabs -->
        <div class="mt-6 card rounded-2xl overflow-hidden">
            <div class="flex border-b border-gray-700">
                <button onclick="showTab('market')" class="tab-btn flex-1 py-3 hover:bg-gray-700 transition" data-tab="market">ğŸª íˆ¬ìì‹œì¥</button>
                <button onclick="showTab('simulation')" class="tab-btn flex-1 py-3 hover:bg-gray-700 transition" data-tab="simulation">ğŸ“ˆ ì‹œë®¬ë ˆì´ì…˜</button>
                <button onclick="showTab('portfolio')" class="tab-btn flex-1 py-3 hover:bg-gray-700 transition" data-tab="portfolio">ğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤</button>
            </div>
            <div id="tabContent" class="p-4"></div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="card rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">âš™ï¸ ê²Œì„ ì„¤ì •</h2>
            
            <!-- Player Count -->
            <div class="mb-4">
                <h3 class="font-bold mb-2">ğŸ‘¥ í”Œë ˆì´ì–´ ìˆ˜</h3>
                <div class="flex gap-2">
                    <button onclick="setNumPlayers(1)" class="player-count-btn flex-1 py-3 bg-gray-700 hover:bg-yellow-600 rounded-lg transition" data-count="1">1ì¸</button>
                    <button onclick="setNumPlayers(2)" class="player-count-btn flex-1 py-3 bg-gray-700 hover:bg-blue-600 rounded-lg transition" data-count="2">2ì¸</button>
                    <button onclick="setNumPlayers(3)" class="player-count-btn flex-1 py-3 bg-gray-700 hover:bg-red-600 rounded-lg transition" data-count="3">3ì¸</button>
                    <button onclick="setNumPlayers(4)" class="player-count-btn flex-1 py-3 bg-gray-700 hover:bg-green-600 rounded-lg transition" data-count="4">4ì¸</button>
                </div>
            </div>

            <!-- Player Selection Tabs -->
            <div class="mb-4">
                <h3 class="font-bold mb-2">ğŸ® í”Œë ˆì´ì–´ ì„ íƒ (ì„¤ì •í•  í”Œë ˆì´ì–´ ì„ íƒ)</h3>
                <div id="setupPlayerTabs" class="flex gap-2 mb-3">
                    <button onclick="selectSetupPlayer(0)" class="setup-player-tab flex-1 py-2 bg-yellow-600 rounded-lg transition flex items-center justify-center gap-2" data-player="0">
                        <span>ğŸ­</span> í”Œë ˆì´ì–´ 1
                    </button>
                </div>
            </div>

            <!-- Job Presets -->
            <div class="mb-4">
                <h3 class="font-bold mb-2">ğŸ­ ì§ì—… í”„ë¦¬ì…‹ <span id="presetPlayerLabel" class="text-yellow-400">(í”Œë ˆì´ì–´ 1)</span></h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="presetBtns"></div>
                <div class="mt-2">
                    <span class="text-sm text-gray-400">í˜„ì¬ ì„ íƒëœ ì§ì—…: </span>
                    <span id="selectedJobDisplay" class="text-yellow-400 font-bold">ì—†ìŒ</span>
                </div>
            </div>

            <!-- Custom Settings -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-bold mb-2 text-emerald-400">ğŸ’µ ìˆ˜ì…</h3>
                    <div class="space-y-2">
                        <div><label class="text-sm">ì›”ê¸‰</label><input type="number" id="inpSalary" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ì„ëŒ€ìˆ˜ì…</label><input type="number" id="inpRental" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ë°°ë‹¹ê¸ˆ</label><input type="number" id="inpDividend" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ê¸°íƒ€ìˆ˜ì…</label><input type="number" id="inpOtherInc" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-2 text-red-400">ğŸ’¸ ì§€ì¶œ</h3>
                    <div class="space-y-2">
                        <div><label class="text-sm">ì£¼ê±°ë¹„</label><input type="number" id="expHousing" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ìƒí™œë¹„</label><input type="number" id="expLiving" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ëŒ€ì¶œì´ì</label><input type="number" id="expLoan" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ì„¸ê¸ˆ/ë³´í—˜</label><input type="number" id="expTax" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-2 text-blue-400">ğŸ  ìì‚°</h3>
                    <div class="space-y-2">
                        <div><label class="text-sm">í˜„ê¸ˆ/ì˜ˆê¸ˆ</label><input type="number" id="astCash" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ë¶€ë™ì‚°</label><input type="number" id="astRealEstate" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ì£¼ì‹/ETF</label><input type="number" id="astStocks" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ê°€ìƒìì‚°</label><input type="number" id="astCrypto" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-2 text-orange-400">ğŸ“‰ ë¶€ì±„</h3>
                    <div class="space-y-2">
                        <div><label class="text-sm">ì£¼íƒë‹´ë³´ëŒ€ì¶œ</label><input type="number" id="debtMortgage" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ì‹ ìš©ëŒ€ì¶œ</label><input type="number" id="debtCredit" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">í•™ìê¸ˆëŒ€ì¶œ</label><input type="number" id="debtStudent" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                        <div><label class="text-sm">ê¸°íƒ€ëŒ€ì¶œ</label><input type="number" id="debtOther" class="w-full bg-gray-700 rounded p-2" value="0"></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="applySettingsToPlayer()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">í˜„ì¬ í”Œë ˆì´ì–´ì— ì ìš©</button>
                <button onclick="applySettingsAndClose()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold">ì €ì¥ í›„ ë‹«ê¸°</button>
                <button onclick="hideSetupModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebrateModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="text-8xl celebrate mb-4">ğŸ‰</div>
            <h2 class="text-4xl font-bold text-yellow-400 mb-2">ì¥ ë ˆì´ìŠ¤ íƒˆì¶œ!</h2>
            <p class="text-xl text-gray-300 mb-6">íŒ¨ì‹œë¸Œ ì†Œë“ì´ ì§€ì¶œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!</p>
            <button onclick="enterFastTrack()" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold text-xl">íŒ¨ìŠ¤íŠ¸ íŠ¸ë™ ì§„ì… â†’</button>
        </div>
    </div>

    <script>
        // Player colors for multiplayer
        const playerColors = ['#fbbf24', '#3b82f6', '#ef4444', '#10b981'];
        const playerEmojis = ['ğŸ­', 'ğŸ±', 'ğŸ¶', 'ğŸ°'];
        const playerColorClasses = ['bg-yellow-600', 'bg-blue-600', 'bg-red-600', 'bg-green-600'];

        // Stock/Asset prices (base prices in ë§Œì›)
        let basePrices = {
            'ì‚¼ì„±ì „ì': 7, 'SKí•˜ì´ë‹‰ìŠ¤': 15, 'ë„¤ì´ë²„': 20, 'ì¹´ì¹´ì˜¤': 5,
            'ì• í”Œ': 25, 'í…ŒìŠ¬ë¼': 35, 'ë§ˆì´í¬ë¡œì†Œí”„íŠ¸': 40, 'ì—”ë¹„ë””ì•„': 90,
            'S&P500 ETF': 5, 'ë‚˜ìŠ¤ë‹¥100 ETF': 6, 'ê³ ë°°ë‹¹ ETF': 4, 'ë¦¬ì¸  ETF': 3, 'ì±„ê¶Œ ETF': 10,
            'ê¸ˆ ETF': 8, 'ì€ ETF': 3, 'ì›ìœ  ETF': 5, 'ë†ì‚°ë¬¼ ETF': 4,
            'ë¹„íŠ¸ì½”ì¸': 1000, 'ì´ë”ë¦¬ì›€': 500, 'ì†”ë¼ë‚˜': 200
        };

        let marketPrices = { ...basePrices };

        // Price history for charts (pre-generate some history)
        let priceHistory = {};
        Object.keys(marketPrices).forEach(name => {
            // Generate 10 turns of fake historical data
            let history = [];
            let price = basePrices[name];
            for (let i = 0; i < 10; i++) {
                const change = (Math.random() - 0.5) * 0.15;
                price = Math.max(0.1, price * (1 + change));
                history.push(Math.round(price * 100) / 100);
            }
            history.push(marketPrices[name]);
            priceHistory[name] = history;
        });

        // Game State with multiplayer support
        let numPlayers = 1;
        let currentPlayer = 0;
        let setupPlayer = 0; // Which player we're setting up in the modal
        let players = [];

        function createPlayer() {
            return {
                position: 0, 
                inFastTrack: false,
                job: null, // ì§ì—…ëª…
                jobPreset: null, // í”„ë¦¬ì…‹ëª…
                income: { salary: 0, rental: 0, dividend: 0, other: 0 },
                expenses: { housing: 0, living: 0, loan: 0, tax: 0 },
                assets: { cash: 0, realEstate: 0, stocks: 0, crypto: 0 },
                liabilities: { mortgage: 0, credit: 0, student: 0, other: 0 },
                investments: [],
                children: 0
            };
        }

        // Initialize default player
        players = [createPlayer()];

        // Convenience getter for current player's state
        function getPlayer() { return players[currentPlayer]; }

        // Legacy gameState reference (for backward compatibility)
        let gameState = {
            get position() { return getPlayer().position; },
            set position(v) { getPlayer().position = v; },
            get inFastTrack() { return getPlayer().inFastTrack; },
            set inFastTrack(v) { getPlayer().inFastTrack = v; },
            get income() { return getPlayer().income; },
            set income(v) { getPlayer().income = v; },
            get expenses() { return getPlayer().expenses; },
            set expenses(v) { getPlayer().expenses = v; },
            get assets() { return getPlayer().assets; },
            set assets(v) { getPlayer().assets = v; },
            get liabilities() { return getPlayer().liabilities; },
            set liabilities(v) { getPlayer().liabilities = v; },
            get investments() { return getPlayer().investments; },
            set investments(v) { getPlayer().investments = v; },
            get children() { return getPlayer().children; },
            set children(v) { getPlayer().children = v; },
            turn: 1
        };

        // Presets
        const presets = {
            'ì‚¬íšŒì´ˆë…„ìƒ': { job: 'ì‹ ì…ì‚¬ì›', income: { salary: 280, rental: 0, dividend: 0, other: 0 }, expenses: { housing: 50, living: 80, loan: 30, tax: 40 }, assets: { cash: 500, realEstate: 0, stocks: 0, crypto: 0 }, liabilities: { mortgage: 0, credit: 0, student: 2000, other: 0 } },
            'ì§ì¥ì¸5ë…„ì°¨': { job: 'ëŒ€ë¦¬', income: { salary: 400, rental: 0, dividend: 5, other: 0 }, expenses: { housing: 80, living: 100, loan: 50, tax: 60 }, assets: { cash: 3000, realEstate: 0, stocks: 1000, crypto: 200 }, liabilities: { mortgage: 0, credit: 500, student: 1000, other: 0 } },
            'íˆ¬ìì': { job: 'ì „ì—…íˆ¬ìì', income: { salary: 0, rental: 200, dividend: 150, other: 100 }, expenses: { housing: 100, living: 150, loan: 100, tax: 80 }, assets: { cash: 10000, realEstate: 50000, stocks: 30000, crypto: 5000 }, liabilities: { mortgage: 30000, credit: 0, student: 0, other: 0 } },
            'ê³ ì•¡ìì‚°ê°€': { job: 'ì‚¬ì—…ê°€', income: { salary: 0, rental: 500, dividend: 300, other: 400 }, expenses: { housing: 200, living: 300, loan: 200, tax: 200 }, assets: { cash: 50000, realEstate: 200000, stocks: 100000, crypto: 20000 }, liabilities: { mortgage: 80000, credit: 0, student: 0, other: 5000 } },
            'ì˜ì‚¬': { job: 'ì „ë¬¸ì˜', income: { salary: 1200, rental: 0, dividend: 20, other: 0 }, expenses: { housing: 150, living: 200, loan: 300, tax: 250 }, assets: { cash: 5000, realEstate: 0, stocks: 3000, crypto: 0 }, liabilities: { mortgage: 0, credit: 2000, student: 10000, other: 0 } },
            'ë³€í˜¸ì‚¬': { job: 'ë³€í˜¸ì‚¬', income: { salary: 900, rental: 0, dividend: 30, other: 100 }, expenses: { housing: 120, living: 180, loan: 150, tax: 200 }, assets: { cash: 8000, realEstate: 0, stocks: 5000, crypto: 500 }, liabilities: { mortgage: 0, credit: 1000, student: 5000, other: 0 } },
            'ê³µë¬´ì›': { job: '7ê¸‰ê³µë¬´ì›', income: { salary: 320, rental: 0, dividend: 0, other: 0 }, expenses: { housing: 60, living: 90, loan: 40, tax: 30 }, assets: { cash: 2000, realEstate: 0, stocks: 500, crypto: 0 }, liabilities: { mortgage: 0, credit: 0, student: 500, other: 0 } },
            'ìì˜ì—…ì': { job: 'ì‹ë‹¹ìš´ì˜', income: { salary: 0, rental: 0, dividend: 0, other: 500 }, expenses: { housing: 80, living: 120, loan: 100, tax: 80 }, assets: { cash: 3000, realEstate: 10000, stocks: 0, crypto: 0 }, liabilities: { mortgage: 0, credit: 3000, student: 0, other: 5000 } }
        };

        // Rat Race Spaces
        const ratRaceSpaces = [
            { type: 'payday', name: 'ğŸ’°ì›”ê¸‰ë‚ ', color: '#10b981' },
            { type: 'opportunity', name: 'ğŸ ë¶€ë™ì‚°', color: '#3b82f6' },
            { type: 'market', name: 'ğŸ“ˆì‹œì¥ìƒìŠ¹', color: '#22c55e' },
            { type: 'doodad', name: 'ğŸ›’ì¶©ë™ì§€ì¶œ', color: '#ef4444' },
            { type: 'opportunity', name: 'ğŸ“Šì£¼ì‹', color: '#8b5cf6' },
            { type: 'charity', name: 'â¤ï¸ê¸°ë¶€', color: '#ec4899' },
            { type: 'payday', name: 'ğŸ’°ì›”ê¸‰ë‚ ', color: '#10b981' },
            { type: 'opportunity', name: 'ğŸ’ê°€ìƒìì‚°', color: '#f59e0b' },
            { type: 'market', name: 'ğŸ“‰ì‹œì¥í•˜ë½', color: '#dc2626' },
            { type: 'baby', name: 'ğŸ‘¶ì•„ê¸°íƒ„ìƒ', color: '#f472b6' },
            { type: 'opportunity', name: 'ğŸ¢ìƒê°€íˆ¬ì', color: '#06b6d4' },
            { type: 'doodad', name: 'ğŸ›’ì¶©ë™ì§€ì¶œ', color: '#ef4444' },
            { type: 'payday', name: 'ğŸ’°ì›”ê¸‰ë‚ ', color: '#10b981' },
            { type: 'opportunity', name: 'ğŸ ê²½ë§¤ë¬¼ê±´', color: '#0891b2' },
            { type: 'layoff', name: 'ğŸ˜¢í•´ê³ ', color: '#991b1b' },
            { type: 'opportunity', name: 'ğŸ“ŠETF', color: '#7c3aed' },
            { type: 'market', name: 'ğŸ“ˆì‹œì¥ìƒìŠ¹', color: '#22c55e' },
            { type: 'doodad', name: 'ğŸ›’ì¶©ë™ì§€ì¶œ', color: '#ef4444' },
            { type: 'payday', name: 'ğŸ’°ì›”ê¸‰ë‚ ', color: '#10b981' },
            { type: 'opportunity', name: 'ğŸ ì›ë£¸', color: '#2563eb' },
            { type: 'charity', name: 'â¤ï¸ê¸°ë¶€', color: '#ec4899' },
            { type: 'opportunity', name: 'ğŸ’°ìŠ¤í…Œì´í‚¹', color: '#d97706' },
            { type: 'baby', name: 'ğŸ‘¶ì•„ê¸°íƒ„ìƒ', color: '#f472b6' },
            { type: 'market', name: 'ğŸ“‰ì‹œì¥í•˜ë½', color: '#dc2626' }
        ];

        const fastTrackSpaces = [
            { type: 'dream', name: 'ğŸï¸ì„¬êµ¬ë§¤', cost: 500000, color: '#fbbf24' },
            { type: 'dream', name: 'ğŸš€ìš°ì£¼ì—¬í–‰', cost: 300000, color: '#a855f7' },
            { type: 'dream', name: 'ğŸ°ì„±êµ¬ë§¤', cost: 1000000, color: '#f97316' },
            { type: 'dream', name: 'ğŸ¨ì˜ˆìˆ ì»¬ë ‰ì…˜', cost: 200000, color: '#14b8a6' },
            { type: 'dream', name: 'ğŸï¸ìŠˆí¼ì¹´', cost: 150000, color: '#ef4444' },
            { type: 'dream', name: 'ğŸŒì„¸ê³„ì—¬í–‰', cost: 100000, color: '#3b82f6' },
            { type: 'dream', name: 'ğŸ¥ìì„ ì¬ë‹¨', cost: 500000, color: '#ec4899' },
            { type: 'dream', name: 'ğŸ¯ê¿ˆë‹¬ì„±!', cost: 0, color: '#10b981' }
        ];

        // Initialize
        function init() {
            createPresetButtons();
            drawBoard();
            updateUI();
            showTab('market');
            updateCurrentPlayerDisplay();
            if (localStorage.getItem('cashflowGame')) {
                if (confirm('ì €ì¥ëœ ê²Œì„ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) loadGame();
                else showSetupModal();
            } else showSetupModal();
        }

        function createPresetButtons() {
            const container = document.getElementById('presetBtns');
            container.innerHTML = Object.keys(presets).map(name =>
                `<button onclick="applyPreset('${name}')" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">${name}</button>`
            ).join('');
        }

        function applyPreset(name) {
            const p = presets[name];
            document.getElementById('inpSalary').value = p.income.salary;
            document.getElementById('inpRental').value = p.income.rental;
            document.getElementById('inpDividend').value = p.income.dividend;
            document.getElementById('inpOtherInc').value = p.income.other;
            document.getElementById('expHousing').value = p.expenses.housing;
            document.getElementById('expLiving').value = p.expenses.living;
            document.getElementById('expLoan').value = p.expenses.loan;
            document.getElementById('expTax').value = p.expenses.tax;
            document.getElementById('astCash').value = p.assets.cash;
            document.getElementById('astRealEstate').value = p.assets.realEstate;
            document.getElementById('astStocks').value = p.assets.stocks;
            document.getElementById('astCrypto').value = p.assets.crypto;
            document.getElementById('debtMortgage').value = p.liabilities.mortgage;
            document.getElementById('debtCredit').value = p.liabilities.credit;
            document.getElementById('debtStudent').value = p.liabilities.student;
            document.getElementById('debtOther').value = p.liabilities.other;
            
            document.getElementById('selectedJobDisplay').textContent = `${name} (${p.job})`;
            
            // Store selected preset for this player
            players[setupPlayer].jobPreset = name;
            players[setupPlayer].job = p.job;
        }

        function selectSetupPlayer(idx) {
            setupPlayer = idx;
            
            // Update tabs UI
            document.querySelectorAll('.setup-player-tab').forEach((tab, i) => {
                tab.classList.remove(...playerColorClasses, 'bg-gray-700');
                tab.classList.add(i === idx ? playerColorClasses[i] : 'bg-gray-700');
            });
            
            document.getElementById('presetPlayerLabel').textContent = `(í”Œë ˆì´ì–´ ${idx + 1})`;
            
            // Load this player's current settings into the form
            loadPlayerSettingsToForm(idx);
        }

        function loadPlayerSettingsToForm(idx) {
            const p = players[idx];
            document.getElementById('inpSalary').value = p.income.salary;
            document.getElementById('inpRental').value = p.income.rental;
            document.getElementById('inpDividend').value = p.income.dividend;
            document.getElementById('inpOtherInc').value = p.income.other;
            document.getElementById('expHousing').value = p.expenses.housing;
            document.getElementById('expLiving').value = p.expenses.living;
            document.getElementById('expLoan').value = p.expenses.loan;
            document.getElementById('expTax').value = p.expenses.tax;
            document.getElementById('astCash').value = p.assets.cash;
            document.getElementById('astRealEstate').value = p.assets.realEstate;
            document.getElementById('astStocks').value = p.assets.stocks;
            document.getElementById('astCrypto').value = p.assets.crypto;
            document.getElementById('debtMortgage').value = p.liabilities.mortgage;
            document.getElementById('debtCredit').value = p.liabilities.credit;
            document.getElementById('debtStudent').value = p.liabilities.student;
            document.getElementById('debtOther').value = p.liabilities.other;
            
            document.getElementById('selectedJobDisplay').textContent = p.job ? `${p.jobPreset || ''} (${p.job})` : 'ì—†ìŒ';
        }

        function applySettingsToPlayer() {
            const p = players[setupPlayer];
            p.income = { 
                salary: +document.getElementById('inpSalary').value, 
                rental: +document.getElementById('inpRental').value, 
                dividend: +document.getElementById('inpDividend').value, 
                other: +document.getElementById('inpOtherInc').value 
            };
            p.expenses = { 
                housing: +document.getElementById('expHousing').value, 
                living: +document.getElementById('expLiving').value, 
                loan: +document.getElementById('expLoan').value, 
                tax: +document.getElementById('expTax').value 
            };
            p.assets = { 
                cash: +document.getElementById('astCash').value, 
                realEstate: +document.getElementById('astRealEstate').value, 
                stocks: +document.getElementById('astStocks').value, 
                crypto: +document.getElementById('astCrypto').value 
            };
            p.liabilities = { 
                mortgage: +document.getElementById('debtMortgage').value, 
                credit: +document.getElementById('debtCredit').value, 
                student: +document.getElementById('debtStudent').value, 
                other: +document.getElementById('debtOther').value 
            };
            
            alert(`í”Œë ˆì´ì–´ ${setupPlayer + 1} ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            updateUI();
        }

        function applySettingsAndClose() {
            applySettingsToPlayer();
            hideSetupModal();
        }

        function applySettings() {
            applySettingsToPlayer();
            hideSetupModal();
            updateUI();
        }

        function showSetupModal() { 
            document.getElementById('setupModal').classList.remove('hidden'); 
            updateSetupPlayerTabs();
            selectSetupPlayer(0);
        }
        
        function hideSetupModal() { 
            document.getElementById('setupModal').classList.add('hidden'); 
            updateCurrentPlayerDisplay();
        }

        function updateSetupPlayerTabs() {
            const container = document.getElementById('setupPlayerTabs');
            container.innerHTML = players.map((p, i) => `
                <button onclick="selectSetupPlayer(${i})" class="setup-player-tab flex-1 py-2 ${i === setupPlayer ? playerColorClasses[i] : 'bg-gray-700'} rounded-lg transition flex items-center justify-center gap-2" data-player="${i}">
                    <span>${playerEmojis[i]}</span> í”Œë ˆì´ì–´ ${i + 1}
                    ${p.job ? `<span class="text-xs">(${p.job})</span>` : ''}
                </button>
            `).join('');
        }

        function updateCurrentPlayerDisplay() {
            const p = getPlayer();
            document.getElementById('currentPlayerEmoji').textContent = playerEmojis[currentPlayer];
            document.getElementById('currentPlayerName').textContent = `í”Œë ˆì´ì–´ ${currentPlayer + 1}`;
            document.getElementById('currentPlayerJob').textContent = p.job || 'ì§ì—… ë¯¸ì„ íƒ';
            document.getElementById('currentPlayerDisplay').style.borderColor = playerColors[currentPlayer];
            document.getElementById('currentPlayerDisplay').style.borderWidth = '2px';
            
            // Update player tabs
            updatePlayerTabs();
        }

        function updatePlayerTabs() {
            const container = document.getElementById('playerTabs');
            if (numPlayers > 1) {
                container.classList.remove('hidden');
                container.innerHTML = players.map((p, i) => `
                    <div class="player-tab card rounded-xl px-4 py-2 flex items-center gap-2 ${i === currentPlayer ? 'active ring-2' : 'opacity-60'}" style="border-color: ${playerColors[i]}; ${i === currentPlayer ? `ring-color: ${playerColors[i]}` : ''}">
                        <span class="text-xl">${playerEmojis[i]}</span>
                        <div>
                            <div class="font-bold text-sm">P${i + 1}</div>
                            <div class="text-xs text-gray-400">${p.job || 'ë¯¸ì„ íƒ'}</div>
                        </div>
                        <div class="text-xs ml-2">
                            <div class="text-emerald-400">â‚©${fmt(Object.values(p.assets).reduce((a,b)=>a+b,0))}ë§Œ</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        // Draw Board
        function drawBoard() {
            const svg = document.getElementById('gameBoard');
            let html = '';
            const cx = 280, cy = 280, r1 = 230, r2 = 130;

            const getIcon = (name) => {
                if (name.includes('ì›”ê¸‰')) return 'ğŸ’°';
                if (name.includes('ë¶€ë™ì‚°') || name.includes('ì›ë£¸') || name.includes('ê²½ë§¤')) return 'ğŸ ';
                if (name.includes('ìƒìŠ¹')) return 'ğŸ“ˆ';
                if (name.includes('í•˜ë½')) return 'ğŸ“‰';
                if (name.includes('ì¶©ë™')) return 'ğŸ›’';
                if (name.includes('ì£¼ì‹') || name.includes('ETF')) return 'ğŸ“Š';
                if (name.includes('ê¸°ë¶€')) return 'â¤';
                if (name.includes('ê°€ìƒ') || name.includes('ìŠ¤í…Œì´í‚¹')) return 'ğŸ’';
                if (name.includes('ì•„ê¸°')) return 'ğŸ‘¶';
                if (name.includes('ìƒê°€')) return 'ğŸ¢';
                if (name.includes('í•´ê³ ')) return 'ğŸ˜¢';
                if (name.includes('ì„¬')) return 'ğŸ';
                if (name.includes('ìš°ì£¼')) return 'ğŸš€';
                if (name.includes('ì„±êµ¬ë§¤')) return 'ğŸ°';
                if (name.includes('ì˜ˆìˆ ')) return 'ğŸ¨';
                if (name.includes('ìŠˆí¼ì¹´')) return 'ğŸ';
                if (name.includes('ì„¸ê³„')) return 'ğŸŒ';
                if (name.includes('ìì„ ')) return 'ğŸ¥';
                if (name.includes('ê¿ˆë‹¬ì„±')) return 'ğŸ¯';
                return 'â—';
            };

            // Rat Race
            ratRaceSpaces.forEach((space, i) => {
                const angle = (i / 24) * Math.PI * 2 - Math.PI / 2;
                const x = cx + r1 * Math.cos(angle), y = cy + r1 * Math.sin(angle);
                html += `<g class="track-space" onclick="showSpaceInfo(${i}, false)">
                    <circle cx="${x}" cy="${y}" r="24" fill="${space.color}" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                    <text x="${x}" y="${y + 2}" text-anchor="middle" dominant-baseline="middle" font-size="18" style="font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif;">${getIcon(space.name)}</text>
                </g>`;
            });

            // Fast Track
            fastTrackSpaces.forEach((space, i) => {
                const angle = (i / 8) * Math.PI * 2 - Math.PI / 2;
                const x = cx + r2 * Math.cos(angle), y = cy + r2 * Math.sin(angle);
                html += `<g class="track-space" onclick="showSpaceInfo(${i}, true)">
                    <circle cx="${x}" cy="${y}" r="22" fill="${space.color}" stroke="#fbbf2466" stroke-width="2"/>
                    <text x="${x}" y="${y + 2}" text-anchor="middle" dominant-baseline="middle" font-size="16" style="font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif;">${getIcon(space.name)}</text>
                </g>`;
            });

            // Player Tokens
            players.forEach((player, pIdx) => {
                const track = player.inFastTrack ? fastTrackSpaces : ratRaceSpaces;
                const radius = player.inFastTrack ? r2 : r1;
                const baseAngle = (player.position / track.length) * Math.PI * 2 - Math.PI / 2;
                const offset = pIdx * 0.05;
                const angle = baseAngle + offset;
                const px = cx + (radius - 30) * Math.cos(angle), py = cy + (radius - 30) * Math.sin(angle);
                const isCurrentTurn = pIdx === currentPlayer;
                html += `<circle class="token" cx="${px}" cy="${py}" r="${isCurrentTurn ? 16 : 12}" fill="${isCurrentTurn ? '#fff' : '#333'}" stroke="${playerColors[pIdx]}" stroke-width="4"/>
                    <text x="${px}" y="${py + 2}" text-anchor="middle" dominant-baseline="middle" font-size="${isCurrentTurn ? 16 : 12}" style="font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif;">${playerEmojis[pIdx]}</text>`;
            });

            // Center Text
            html += `<text x="${cx}" y="${cy - 15}" text-anchor="middle" font-size="16" fill="#9ca3af">${getPlayer().inFastTrack ? 'íŒ¨ìŠ¤íŠ¸ íŠ¸ë™' : 'ì¥ ë ˆì´ìŠ¤'}</text>
                <text x="${cx}" y="${cy + 10}" text-anchor="middle" font-size="20" fill="#fbbf24" font-weight="bold">í„´ ${gameState.turn}</text>
                <text x="${cx}" y="${cy + 35}" text-anchor="middle" font-size="14" fill="${playerColors[currentPlayer]}">í”Œë ˆì´ì–´ ${currentPlayer + 1}</text>`;

            svg.innerHTML = html;
        }

        function showSpaceInfo(idx, isFast) {
            const space = isFast ? fastTrackSpaces[idx] : ratRaceSpaces[idx];
            alert(`${space.name}\níƒ€ì…: ${space.type}${space.cost ? '\në¹„ìš©: â‚©' + fmt(space.cost) : ''}`);
        }

        // Dice
        let currentEvent = null;
        function rollDice() {
            const dice = document.getElementById('dice');
            dice.classList.add('rolling');
            const diceEmojis = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
            let rolls = 0;
            const interval = setInterval(() => {
                dice.textContent = diceEmojis[Math.floor(Math.random() * 6)];
                if (++rolls > 10) {
                    clearInterval(interval);
                    dice.classList.remove('rolling');
                    const result = Math.floor(Math.random() * 6) + 1;
                    dice.textContent = diceEmojis[result - 1];
                    movePlayer(result);
                }
            }, 100);
        }

        function movePlayer(steps) {
            const track = gameState.inFastTrack ? fastTrackSpaces : ratRaceSpaces;
            gameState.position = (gameState.position + steps) % track.length;
            drawBoard();
            setTimeout(() => triggerEvent(track[gameState.position]), 500);
        }

        function triggerEvent(space) {
            const card = document.getElementById('eventCard');
            const title = document.getElementById('eventTitle');
            const desc = document.getElementById('eventDesc');
            const priceInfo = document.getElementById('priceChangeInfo');

            currentEvent = { type: space.type, space };
            title.textContent = space.name;
            priceInfo.classList.add('hidden');

            switch (space.type) {
                case 'payday':
                    const cf = getCashflow();
                    desc.textContent = `ì›”ê¸‰ë‚ ì…ë‹ˆë‹¤! ìºì‹œí”Œë¡œìš° â‚©${fmt(cf)}ë§Œì›ì´ ë“¤ì–´ì˜µë‹ˆë‹¤.`;
                    break;
                case 'opportunity':
                    desc.textContent = 'íˆ¬ì ê¸°íšŒê°€ ì™”ìŠµë‹ˆë‹¤! íˆ¬ìì‹œì¥ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
                    break;
                case 'doodad':
                    const doodadCost = Math.floor(Math.random() * 50 + 20);
                    currentEvent.cost = doodadCost;
                    desc.textContent = `ì¶©ë™êµ¬ë§¤! â‚©${doodadCost}ë§Œì›ì„ ì§€ì¶œí•©ë‹ˆë‹¤.`;
                    break;
                case 'market':
                    const change = space.name.includes('ìƒìŠ¹') ? Math.floor(Math.random() * 20 + 10) : -Math.floor(Math.random() * 20 + 10);
                    currentEvent.change = change;
                    desc.textContent = `ì‹œì¥ì´ ${change > 0 ? 'ìƒìŠ¹' : 'í•˜ë½'}í–ˆìŠµë‹ˆë‹¤! íˆ¬ììì‚° ${change}% ë³€ë™.`;
                    break;
                case 'baby':
                    desc.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ì•„ê¸°ê°€ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤. ì›” ì§€ì¶œì´ ì¦ê°€í•©ë‹ˆë‹¤.';
                    break;
                case 'charity':
                    desc.textContent = 'ê¸°ë¶€ ê¸°íšŒ! ë‹¤ìŒ 3í„´ê°„ ì£¼ì‚¬ìœ„ 2ê°œë¥¼ êµ´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    break;
                case 'layoff':
                    desc.textContent = 'í•´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤! 2í„´ì„ ì‰¬ì–´ì•¼ í•©ë‹ˆë‹¤.';
                    break;
                case 'dream':
                    desc.textContent = space.cost > 0 ? `${space.name}ì„ ë‹¬ì„±í•˜ë ¤ë©´ â‚©${fmt(space.cost)}ë§Œì›ì´ í•„ìš”í•©ë‹ˆë‹¤.` : 'ëª¨ë“  ê¿ˆì„ ì´ë£¨ì—ˆìŠµë‹ˆë‹¤! ì¶•í•˜í•©ë‹ˆë‹¤!';
                    break;
            }
            card.classList.remove('hidden');
        }

        function handleEvent() {
            if (!currentEvent) return;
            switch (currentEvent.type) {
                case 'payday':
                    gameState.assets.cash += getCashflow();
                    break;
                case 'doodad':
                    gameState.assets.cash -= currentEvent.cost;
                    break;
                case 'market':
                    const pct = 1 + currentEvent.change / 100;
                    gameState.assets.stocks = Math.floor(gameState.assets.stocks * pct);
                    gameState.assets.crypto = Math.floor(gameState.assets.crypto * pct);
                    break;
                case 'baby':
                    gameState.children++;
                    gameState.expenses.living += 30;
                    break;
            }
            document.getElementById('eventCard').classList.add('hidden');

            // Update market prices with random fluctuation
            const priceChanges = updateMarketPrices();
            
            // Show price changes info
            showPriceChangesNotification(priceChanges);

            // Next player's turn
            currentPlayer = (currentPlayer + 1) % numPlayers;
            if (currentPlayer === 0) {
                gameState.turn++;
            }
            document.getElementById('turnCount').textContent = gameState.turn;

            updateUI();
            updateCurrentPlayerDisplay();
            checkEscape();
            currentEvent = null;
        }

        // Update market prices with random fluctuation (enhanced)
        function updateMarketPrices() {
            const changes = [];
            Object.keys(marketPrices).forEach(name => {
                const oldPrice = marketPrices[name];
                // -10% to +10% random change
                const changePercent = (Math.random() - 0.5) * 0.2;
                marketPrices[name] = Math.max(0.1, marketPrices[name] * (1 + changePercent));
                marketPrices[name] = Math.round(marketPrices[name] * 100) / 100;
                
                priceHistory[name].push(marketPrices[name]);
                if (priceHistory[name].length > 30) priceHistory[name].shift();
                
                changes.push({
                    name,
                    oldPrice,
                    newPrice: marketPrices[name],
                    changePercent: ((marketPrices[name] - oldPrice) / oldPrice * 100).toFixed(1)
                });
            });

            // Update investment values based on new prices
            players.forEach(player => {
                player.investments.forEach(inv => {
                    if (inv.shares && inv.name && marketPrices[inv.name]) {
                        inv.currentPrice = marketPrices[inv.name];
                        inv.currentValue = inv.shares * inv.currentPrice;
                    }
                });
            });
            
            return changes;
        }

        function showPriceChangesNotification(changes) {
            // Show top movers
            const sorted = [...changes].sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
            const topMovers = sorted.slice(0, 5);
            
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 card rounded-xl p-4 z-40 animate-bounce';
            notification.innerHTML = `
                <div class="text-sm font-bold mb-2">ğŸ“Š ì‹œì¥ ë³€ë™</div>
                ${topMovers.map(m => `
                    <div class="text-xs flex justify-between gap-4">
                        <span>${m.name}</span>
                        <span class="${m.changePercent > 0 ? 'text-emerald-400' : 'text-red-400'}">${m.changePercent > 0 ? '+' : ''}${m.changePercent}%</span>
                    </div>
                `).join('')}
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Set number of players
        function setNumPlayers(n) {
            numPlayers = n;
            players = [];
            for (let i = 0; i < n; i++) {
                players.push(createPlayer());
            }
            currentPlayer = 0;

            document.querySelectorAll('.player-count-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-600', 'bg-blue-600', 'bg-red-600', 'bg-green-600');
                btn.classList.add('bg-gray-700');
            });
            const colors = ['bg-yellow-600', 'bg-blue-600', 'bg-red-600', 'bg-green-600'];
            document.querySelector(`[data-count="${n}"]`).classList.remove('bg-gray-700');
            document.querySelector(`[data-count="${n}"]`).classList.add(colors[n - 1]);

            updateSetupPlayerTabs();
            drawBoard();
            updatePlayerTabs();
        }

        // Calculations
        function getCashflow() {
            const totalIncome = Object.values(gameState.income).reduce((a, b) => a + b, 0);
            const totalExpense = Object.values(gameState.expenses).reduce((a, b) => a + b, 0) + gameState.children * 30;
            return totalIncome - totalExpense;
        }

        function getPassiveIncome() {
            return gameState.income.rental + gameState.income.dividend + gameState.income.other;
        }

        function getTotalExpenses() {
            return Object.values(gameState.expenses).reduce((a, b) => a + b, 0) + gameState.children * 30;
        }

        function getTotalAssets() { return Object.values(gameState.assets).reduce((a, b) => a + b, 0); }
        function getTotalLiabilities() { return Object.values(gameState.liabilities).reduce((a, b) => a + b, 0); }

        function fmt(n) { return n.toLocaleString(); }

        function updateUI() {
            document.getElementById('incSalary').textContent = `â‚©${fmt(gameState.income.salary)}ë§Œ`;
            document.getElementById('incPassive').textContent = `â‚©${fmt(getPassiveIncome())}ë§Œ`;
            document.getElementById('expTotal').textContent = `â‚©${fmt(getTotalExpenses())}ë§Œ`;
            document.getElementById('cashflow').textContent = `â‚©${fmt(getCashflow())}ë§Œ`;
            document.getElementById('totalAssets').textContent = `â‚©${fmt(getTotalAssets())}ë§Œ`;
            document.getElementById('totalLiabilities').textContent = `â‚©${fmt(getTotalLiabilities())}ë§Œ`;
            document.getElementById('netWorth').textContent = `â‚©${fmt(getTotalAssets() - getTotalLiabilities())}ë§Œ`;

            document.getElementById('dashCash').textContent = `â‚©${fmt(gameState.assets.cash)}ë§Œ`;
            document.getElementById('dashAssets').textContent = `â‚©${fmt(getTotalAssets())}ë§Œ`;
            document.getElementById('dashDebt').textContent = `â‚©${fmt(getTotalLiabilities())}ë§Œ`;
            document.getElementById('dashNetWorth').textContent = `â‚©${fmt(getTotalAssets() - getTotalLiabilities())}ë§Œ`;
            document.getElementById('dashCashflow').textContent = `â‚©${fmt(getCashflow())}ë§Œ`;

            const progress = Math.min(100, (getPassiveIncome() / Math.max(1, getTotalExpenses())) * 100);
            document.getElementById('escapeProgress').style.width = progress + '%';
            
            // Update asset/liability summary lists
            updateSummaryLists();
            
            drawBoard();
            updatePlayerTabs();
    const activeTab = document.querySelector('.tab-btn.bg-gray-700');
    if (activeTab) {
        const tabName = activeTab.getAttribute('data-tab');
        showTab(tabName);
    }
            
        }

        // Update summary lists under balance sheet
        function updateSummaryLists() {
            const assets = gameState.assets;
            const liab = gameState.liabilities;
            const inv = gameState.investments;
            
            // Asset summary
            let assetHtml = '';
            if (assets.cash > 0) assetHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('cash')"><span>ğŸ’µ í˜„ê¸ˆ</span><span class="text-emerald-400">â‚©${fmt(assets.cash)}ë§Œ</span></div>`;
            if (assets.realEstate > 0) assetHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('assets')"><span>ğŸ  ë¶€ë™ì‚°</span><span class="text-blue-400">â‚©${fmt(assets.realEstate)}ë§Œ</span></div>`;
            if (assets.stocks > 0) assetHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('assets')"><span>ğŸ“Š ì£¼ì‹/ETF</span><span class="text-purple-400">â‚©${fmt(assets.stocks)}ë§Œ</span></div>`;
            if (assets.crypto > 0) assetHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('assets')"><span>ğŸ’ ê°€ìƒìì‚°</span><span class="text-yellow-400">â‚©${fmt(assets.crypto)}ë§Œ</span></div>`;
            
            // Add individual investments that can be clicked for charts
            inv.forEach((item, idx) => {
                if (item.shares && marketPrices[item.name]) {
                    const currentValue = Math.round(item.shares * marketPrices[item.name]);
                    const pnl = currentValue - item.cost;
                    assetHtml += `<div class="asset-item flex justify-between p-1 rounded text-[10px]" onclick="showAssetChart('${item.name}')">
                        <span class="text-gray-400">â”” ${item.name} (${item.shares}ì£¼)</span>
                        <span class="${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}">â‚©${fmt(currentValue)}ë§Œ</span>
                    </div>`;
                }
            });
            
            document.getElementById('assetSummaryList').innerHTML = assetHtml || '<div class="text-gray-500">ìì‚° ì—†ìŒ</div>';
            
            // Liability summary
            let liabHtml = '';
            if (liab.mortgage > 0) liabHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('liabilities')"><span>ğŸ  ì£¼íƒë‹´ë³´</span><span class="text-orange-400">â‚©${fmt(liab.mortgage)}ë§Œ</span></div>`;
            if (liab.credit > 0) liabHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('liabilities')"><span>ğŸ’³ ì‹ ìš©ëŒ€ì¶œ</span><span class="text-orange-400">â‚©${fmt(liab.credit)}ë§Œ</span></div>`;
            if (liab.student > 0) liabHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('liabilities')"><span>ğŸ“ í•™ìê¸ˆ</span><span class="text-orange-400">â‚©${fmt(liab.student)}ë§Œ</span></div>`;
            if (liab.other > 0) liabHtml += `<div class="asset-item flex justify-between p-1 rounded" onclick="showDetailModal('liabilities')"><span>ğŸ“„ ê¸°íƒ€</span><span class="text-orange-400">â‚©${fmt(liab.other)}ë§Œ</span></div>`;
            
            document.getElementById('liabilitySummaryList').innerHTML = liabHtml || '<div class="text-gray-500">ë¶€ì±„ ì—†ìŒ</div>';
        }

        // Asset Price Chart Modal
        let assetChartInstance = null;
        
        function showAssetChart(assetName) {
            const modal = document.getElementById('assetChartModal');
            const title = document.getElementById('assetChartTitle');
            const currentPriceEl = document.getElementById('assetCurrentPrice');
            const priceChangeEl = document.getElementById('assetPriceChange');
            
            title.textContent = `ğŸ“ˆ ${assetName} ê°€ê²© ì°¨íŠ¸`;
            
            const history = priceHistory[assetName] || [];
            const currentPrice = marketPrices[assetName];
            const startPrice = history[0] || currentPrice;
            const totalChange = ((currentPrice - startPrice) / startPrice * 100).toFixed(1);
            
            currentPriceEl.textContent = `â‚©${fmt(currentPrice)}ë§Œ`;
            priceChangeEl.innerHTML = `<span class="${totalChange >= 0 ? 'text-emerald-400' : 'text-red-400'}">${totalChange >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(totalChange)}%</span>`;
            
            modal.classList.remove('hidden');
            
            // Draw chart
            setTimeout(() => {
                const ctx = document.getElementById('assetPriceChart');
                if (assetChartInstance) assetChartInstance.destroy();
                
                assetChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map((_, i) => i === 0 ? 'ì‹œì‘' : i === history.length - 1 ? 'í˜„ì¬' : `${i}í„´ì „`).reverse(),
                        datasets: [{
                            label: 'ê°€ê²© (ë§Œì›)',
                            data: [...history],
                            borderColor: totalChange >= 0 ? '#10b981' : '#ef4444',
                            backgroundColor: totalChange >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: { 
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: v => 'â‚©' + fmt(v)
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }, 100);
        }

        function hideAssetChartModal() {
            document.getElementById('assetChartModal').classList.add('hidden');
        }

        // Detail Modal Functions
        function showDetailModal(type) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailModalTitle');
            const content = document.getElementById('detailModalContent');

            if (type === 'cash') {
                title.textContent = 'ğŸ’µ í˜„ê¸ˆ ìƒì„¸';
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl font-bold text-emerald-400 mb-2">â‚©${fmt(gameState.assets.cash)}ë§Œ</div>
                        <p class="text-gray-400">í˜„ì¬ ë³´ìœ  í˜„ê¸ˆ</p>
                    </div>
                `;
            } else if (type === 'assets') {
                title.textContent = 'ğŸ“Š ìì‚° ìƒì„¸';
                const inv = gameState.investments;
                content.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between p-3 bg-emerald-900/30 rounded-lg">
                            <span>ğŸ’µ í˜„ê¸ˆ</span>
                            <span class="font-bold text-emerald-400">â‚©${fmt(gameState.assets.cash)}ë§Œ</span>
                        </div>
                        <div class="flex justify-between p-3 bg-blue-900/30 rounded-lg">
                            <span>ğŸ  ë¶€ë™ì‚°</span>
                            <span class="font-bold text-blue-400">â‚©${fmt(gameState.assets.realEstate)}ë§Œ</span>
                        </div>
                        <div class="flex justify-between p-3 bg-purple-900/30 rounded-lg">
                            <span>ğŸ“Š ì£¼ì‹/ETF</span>
                            <span class="font-bold text-purple-400">â‚©${fmt(gameState.assets.stocks)}ë§Œ</span>
                        </div>
                        <div class="flex justify-between p-3 bg-yellow-900/30 rounded-lg">
                            <span>ğŸ’ ê°€ìƒìì‚°</span>
                            <span class="font-bold text-yellow-400">â‚©${fmt(gameState.assets.crypto)}ë§Œ</span>
                        </div>
                        <div class="border-t border-gray-600 pt-3 flex justify-between font-bold">
                            <span>ì´ ìì‚°</span>
                            <span class="text-blue-400">â‚©${fmt(getTotalAssets())}ë§Œ</span>
                        </div>
                        ${inv.length > 0 ? `
                            <div class="mt-4">
                                <h4 class="font-bold mb-2">ë³´ìœ  íˆ¬ì ëª©ë¡ (í´ë¦­í•˜ì—¬ ì°¨íŠ¸ ë³´ê¸°)</h4>
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${inv.map((i, idx) => {
                                        const currentValue = i.shares && marketPrices[i.name] ? Math.round(i.shares * marketPrices[i.name]) : i.cost;
                                        const pnl = currentValue - i.cost;
                                        return `
                                        <div class="flex justify-between items-center text-sm p-2 bg-gray-700/50 rounded cursor-pointer hover:bg-gray-600/50" onclick="hideDetailModal(); showAssetChart('${i.name}');">
                                            <span>${i.name} ${i.shares ? `(${i.shares}ì£¼)` : ''}</span>
                                            <div class="flex items-center gap-2">
                                                <span class="${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}">â‚©${fmt(currentValue)}ë§Œ</span>
                                                <span class="text-xs">ğŸ“ˆ</span>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (type === 'liabilities') {
                title.textContent = 'ğŸ“‰ ë¶€ì±„ ìƒì„¸';
                const liab = gameState.liabilities;
                content.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <div>
                                <span>ğŸ  ì£¼íƒë‹´ë³´ëŒ€ì¶œ</span>
                                <div class="text-xs text-gray-400">ê¸ˆë¦¬ 4%</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-orange-400">â‚©${fmt(liab.mortgage)}ë§Œ</span>
                                ${liab.mortgage > 0 ? `<button onclick="payDebt('mortgage')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs">ìƒí™˜</button>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <div>
                                <span>ğŸ’³ ì‹ ìš©ëŒ€ì¶œ</span>
                                <div class="text-xs text-gray-400">ê¸ˆë¦¬ 8%</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-orange-400">â‚©${fmt(liab.credit)}ë§Œ</span>
                                ${liab.credit > 0 ? `<button onclick="payDebt('credit')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs">ìƒí™˜</button>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <div>
                                <span>ğŸ“ í•™ìê¸ˆëŒ€ì¶œ</span>
                                <div class="text-xs text-gray-400">ê¸ˆë¦¬ 3%</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-orange-400">â‚©${fmt(liab.student)}ë§Œ</span>
                                ${liab.student > 0 ? `<button onclick="payDebt('student')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs">ìƒí™˜</button>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <div>
                                <span>ğŸ“„ ê¸°íƒ€ëŒ€ì¶œ</span>
                                <div class="text-xs text-gray-400">ê¸ˆë¦¬ 10%</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-orange-400">â‚©${fmt(liab.other)}ë§Œ</span>
                                ${liab.other > 0 ? `<button onclick="payDebt('other')" class="px-2 py-1 bg-emerald-600 hover:bg-emerald-700 rounded text-xs">ìƒí™˜</button>` : ''}
                            </div>
                        </div>
                        <div class="border-t border-gray-600 pt-3 flex justify-between font-bold">
                            <span>ì´ ë¶€ì±„</span>
                            <span class="text-orange-400">â‚©${fmt(getTotalLiabilities())}ë§Œ</span>
                        </div>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
        }

        function hideDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function payDebt(type) {
            const debtNames = { mortgage: 'ì£¼íƒë‹´ë³´ëŒ€ì¶œ', credit: 'ì‹ ìš©ëŒ€ì¶œ', student: 'í•™ìê¸ˆëŒ€ì¶œ', other: 'ê¸°íƒ€ëŒ€ì¶œ' };
            const currentDebt = gameState.liabilities[type];
            if (currentDebt <= 0) return;

            const amount = parseInt(prompt(`${debtNames[type]} ìƒí™˜\ní˜„ì¬ ì”ì•¡: â‚©${fmt(currentDebt)}ë§Œ\ní˜„ì¬ í˜„ê¸ˆ: â‚©${fmt(gameState.assets.cash)}ë§Œ\n\nìƒí™˜í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”:`, currentDebt));
            if (!amount || amount <= 0) return;
            if (amount > gameState.assets.cash) { alert('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!'); return; }
            if (amount > currentDebt) { alert('ë¶€ì±„ ì”ì•¡ë³´ë‹¤ ë§ì´ ìƒí™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

            gameState.assets.cash -= amount;
            gameState.liabilities[type] -= amount;

            const interestRates = { mortgage: 0.04, credit: 0.08, student: 0.03, other: 0.10 };
            const interestReduction = Math.round(amount * interestRates[type] / 12);
            gameState.expenses.loan = Math.max(0, gameState.expenses.loan - interestReduction);

            updateUI();
            showDetailModal('liabilities');
            alert(`â‚©${fmt(amount)}ë§Œì› ìƒí™˜ ì™„ë£Œ!\nì›” ì´ì â‚©${fmt(interestReduction)}ë§Œì› ì ˆì•½`);
        }

        function checkEscape() {
            if (!gameState.inFastTrack && getPassiveIncome() >= getTotalExpenses()) {
                document.getElementById('celebrateModal').classList.remove('hidden');
            }
        }

        function enterFastTrack() {
            gameState.inFastTrack = true;
            gameState.position = 0;
            document.getElementById('celebrateModal').classList.add('hidden');
            drawBoard();
            updateUI();
        }

        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('bg-gray-700', 'text-yellow-400'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-gray-700', 'text-yellow-400');

            const content = document.getElementById('tabContent');
            if (tab === 'market') content.innerHTML = getMarketHTML();
            else if (tab === 'simulation') content.innerHTML = getSimulationHTML();
            else if (tab === 'portfolio') content.innerHTML = getPortfolioHTML();
        }

        function getMarketHTML() {
    return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="card p-4 rounded-xl border border-blue-500/30"><h4 class="font-bold text-blue-400 mb-3">ğŸ  ë¶€ë™ì‚°</h4>
            <div class="space-y-2 text-sm">
                <button onclick="buyInvestment('realEstate','ì›ë£¸ê±´ë¬¼',15000,50)" class="w-full p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">ì›ë£¸ê±´ë¬¼ â‚©15,000ë§Œ (ì›”â‚©50ë§Œ)</button>
                <button onclick="buyInvestment('realEstate','ìƒê°€',30000,100)" class="w-full p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">ìƒê°€ â‚©30,000ë§Œ (ì›”â‚©100ë§Œ)</button>
                <button onclick="buyInvestment('realEstate','ì•„íŒŒíŠ¸ê°­íˆ¬ì',5000,30)" class="w-full p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">ì•„íŒŒíŠ¸ ê°­íˆ¬ì â‚©5,000ë§Œ</button>
                <button onclick="buyInvestment('realEstate','ì˜¤í”¼ìŠ¤í…”',8000,40)" class="w-full p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">ì˜¤í”¼ìŠ¤í…” â‚©8,000ë§Œ</button>
            </div></div>
        <div class="card p-4 rounded-xl border border-purple-500/30"><h4 class="font-bold text-purple-400 mb-3">ğŸ“Š ì£¼ì‹</h4>
            <div class="space-y-2 text-sm">
                ${['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'ë„¤ì´ë²„', 'ì• í”Œ', 'í…ŒìŠ¬ë¼', 'ì—”ë¹„ë””ì•„'].map(name => {
                    const price = marketPrices[name];
                    const history = priceHistory[name] || [price];
                    const prevPrice = history.length > 1 ? history[history.length - 2] : price;
                    const change = ((price - prevPrice) / prevPrice * 100).toFixed(1);
                    return `<div class="flex items-center gap-1">
                        <button onclick="buyStock('${name}',${price},0.01)" class="flex-1 p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">
                            ${name} â‚©${fmt(price)}ë§Œ/ì£¼ <span class="${change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${change >= 0 ? '+' : ''}${change}%</span>
                        </button>
                        <button onclick="showAssetChart('${name}')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded">ğŸ“ˆ</button>
                    </div>`;
                }).join('')}
            </div></div>
        <div class="card p-4 rounded-xl border border-emerald-500/30"><h4 class="font-bold text-emerald-400 mb-3">ğŸ“ˆ ETF</h4>
            <div class="space-y-2 text-sm">
                ${['S&P500 ETF', 'ë‚˜ìŠ¤ë‹¥100 ETF', 'ê³ ë°°ë‹¹ ETF', 'ë¦¬ì¸  ETF', 'ì±„ê¶Œ ETF'].map(name => {
                    const price = marketPrices[name];
                    const history = priceHistory[name] || [price];
                    const prevPrice = history.length > 1 ? history[history.length - 2] : price;
                    const change = ((price - prevPrice) / prevPrice * 100).toFixed(1);
                    return `<div class="flex items-center gap-1">
                        <button onclick="buyStock('${name}',${price},0.02)" class="flex-1 p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">
                            ${name} â‚©${fmt(price)}ë§Œ/ì£¼ <span class="${change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${change >= 0 ? '+' : ''}${change}%</span>
                        </button>
                        <button onclick="showAssetChart('${name}')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded">ğŸ“ˆ</button>
                    </div>`;
                }).join('')}
            </div></div>
        <div class="card p-4 rounded-xl border border-yellow-500/30"><h4 class="font-bold text-yellow-400 mb-3">ğŸ¥‡ ì›ìì¬</h4>
            <div class="space-y-2 text-sm">
                ${['ê¸ˆ ETF', 'ì€ ETF', 'ì›ìœ  ETF', 'ë†ì‚°ë¬¼ ETF'].map(name => {
                    const price = marketPrices[name];
                    const history = priceHistory[name] || [price];
                    const prevPrice = history.length > 1 ? history[history.length - 2] : price;
                    const change = ((price - prevPrice) / prevPrice * 100).toFixed(1);
                    return `<div class="flex items-center gap-1">
                        <button onclick="buyStock('${name}',${price},0)" class="flex-1 p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">
                            ${name} â‚©${fmt(price)}ë§Œ/ì£¼ <span class="${change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${change >= 0 ? '+' : ''}${change}%</span>
                        </button>
                        <button onclick="showAssetChart('${name}')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded">ğŸ“ˆ</button>
                    </div>`;
                }).join('')}
            </div></div>
        <div class="card p-4 rounded-xl border border-orange-500/30"><h4 class="font-bold text-orange-400 mb-3">ğŸ’ ê°€ìƒìì‚°</h4>
            <div class="space-y-2 text-sm">
                ${['ë¹„íŠ¸ì½”ì¸', 'ì´ë”ë¦¬ì›€', 'ì†”ë¼ë‚˜'].map(name => {
                    const price = marketPrices[name];
                    const history = priceHistory[name] || [price];
                    const prevPrice = history.length > 1 ? history[history.length - 2] : price;
                    const change = ((price - prevPrice) / prevPrice * 100).toFixed(1);
                    return `<div class="flex items-center gap-1">
                        <button onclick="buyInvestment('crypto','${name}',${Math.round(price)},0)" class="flex-1 p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">
                            ${name} â‚©${fmt(price)}ë§Œ <span class="${change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${change >= 0 ? '+' : ''}${change}%</span>
                        </button>
                        <button onclick="showAssetChart('${name}')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded">ğŸ“ˆ</button>
                    </div>`;
                }).join('')}
                <button onclick="buyInvestment('crypto','ìŠ¤í…Œì´ë¸”ì˜ˆì¹˜',1000,5)" class="w-full p-2 bg-gray-700 hover:bg-gray-600 rounded text-left hover:scale-[1.02] transition">ğŸ’µ ìŠ¤í…Œì´ë¸” ì˜ˆì¹˜ (ì›”â‚©5ë§Œ)</button>
            </div></div>
    </div>`;
}

        function buyInvestment(type, name, cost, monthlyIncome) {
            if (gameState.assets.cash < cost) { alert('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!'); return; }
            if (!confirm(`${name}ì„(ë¥¼) â‚©${fmt(cost)}ë§Œì›ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            gameState.assets.cash -= cost;
            gameState.assets[type] += cost;
            if (monthlyIncome > 0) {
                if (type === 'realEstate') gameState.income.rental += monthlyIncome;
                else gameState.income.dividend += monthlyIncome;
            }
            gameState.investments.push({ type, name, cost, monthlyIncome });
            updateUI();
            showTab('portfolio');
        }

        function buyStock(name, pricePerShare, dividendYield) {
            const currentPrice = marketPrices[name] || pricePerShare;
            const shares = parseInt(prompt(`${name} (í˜„ì¬ê°€ â‚©${fmt(currentPrice)}ë§Œ/ì£¼)\nëª‡ ì£¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, '10'));
            if (!shares || shares <= 0) return;
            const totalCost = Math.round(currentPrice * shares);
            const monthlyDividend = Math.floor(totalCost * dividendYield);
            if (gameState.assets.cash < totalCost) { alert(`í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤! í•„ìš”: â‚©${fmt(totalCost)}ë§Œ`); return; }
            if (!confirm(`${name} ${shares}ì£¼ë¥¼ â‚©${fmt(totalCost)}ë§Œì›ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${monthlyDividend > 0 ? `\nì˜ˆìƒ ì›” ë°°ë‹¹: â‚©${fmt(monthlyDividend)}ë§Œ` : ''}`)) return;
            gameState.assets.cash -= totalCost;
            gameState.assets.stocks += totalCost;
            if (monthlyDividend > 0) gameState.income.dividend += monthlyDividend;
            gameState.investments.push({ type: 'stocks', name, cost: totalCost, monthlyIncome: monthlyDividend, shares, pricePerShare: currentPrice });
            updateUI();
            showTab('portfolio');
        }

        function getSimulationHTML() {
            return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-4 rounded-xl">
                    <h4 class="font-bold text-emerald-400 mb-3">ğŸƒ íƒˆì¶œ ì‹œë®¬ë ˆì´ì…˜</h4>
                    <div class="space-y-3">
                        <div><label class="text-sm">ì›” ì €ì¶•ì•¡ (ë§Œì›)</label><input type="number" id="simSave" class="w-full bg-gray-700 rounded p-2" value="${Math.max(0, getCashflow())}"></div>
                        <div><label class="text-sm">ì˜ˆìƒ íˆ¬ììˆ˜ìµë¥  (%/ë…„)</label><input type="number" id="simReturn" class="w-full bg-gray-700 rounded p-2" value="8"></div>
                        <button onclick="runEscapeSim()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
                    </div>
                    <div id="escapeResult" class="mt-4 text-sm"></div>
                </div>
                <div class="card p-4 rounded-xl">
                    <h4 class="font-bold text-blue-400 mb-3">ğŸ“ˆ 30ë…„ ìì‚° ì‹œë®¬ë ˆì´ì…˜</h4>
                    <div class="space-y-3">
                        <div><label class="text-sm">ì‹œë‚˜ë¦¬ì˜¤</label>
                            <select id="simScenario" class="w-full bg-gray-700 rounded p-2">
                                <option value="bear">í•˜ë½ì¥ (-50%)</option>
                                <option value="flat">íš¡ë³´ì¥ (0%)</option>
                                <option value="normal" selected>ë³´í†µ (+8%/ë…„)</option>
                                <option value="bull">ìƒìŠ¹ì¥ (+100%)</option>
                            </select></div>
                        <button onclick="runLongSim()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
                    </div>
                    <canvas id="simChart" class="mt-4"></canvas>
                </div></div>`;
        }

        function runEscapeSim() {
            const save = +document.getElementById('simSave').value;
            const ret = +document.getElementById('simReturn').value / 100 / 12;
            const target = getTotalExpenses();
            let assets = getTotalAssets();
            let passive = getPassiveIncome();
            let months = 0;
            while (passive < target && months < 600) {
                assets += save;
                assets *= (1 + ret);
                passive = assets * ret;
                months++;
            }
            document.getElementById('escapeResult').innerHTML = months < 600
                ? `<div class="p-3 bg-emerald-900/50 rounded-lg">ğŸ‰ <b>${Math.floor(months / 12)}ë…„ ${months % 12}ê°œì›”</b> í›„ íƒˆì¶œ ê°€ëŠ¥!<br>ì˜ˆìƒ ìì‚°: â‚©${fmt(Math.floor(assets))}ë§Œì›</div>`
                : `<div class="p-3 bg-red-900/50 rounded-lg">âš ï¸ 50ë…„ ë‚´ íƒˆì¶œì´ ì–´ë µìŠµë‹ˆë‹¤. ì €ì¶•ë¥ ì„ ë†’ì´ì„¸ìš”.</div>`;
        }

        let simChartInstance = null;
        function runLongSim() {
            const scenario = document.getElementById('simScenario').value;
            const returns = { bear: -0.5, flat: 0, normal: 0.08, bull: 1 };
            const annualReturn = returns[scenario];
            let assets = getTotalAssets();
            const data = [assets];
            for (let y = 1; y <= 30; y++) {
                assets *= (1 + annualReturn);
                assets += getCashflow() * 12;
                data.push(Math.max(0, assets));
            }
            const ctx = document.getElementById('simChart');
            if (simChartInstance) simChartInstance.destroy();
            simChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: Array.from({ length: 31 }, (_, i) => i + 'ë…„'), datasets: [{ label: 'ì´ ìì‚° (ë§Œì›)', data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.2)', fill: true, tension: 0.3 }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } } }, scales: { x: { ticks: { color: '#9ca3af' } }, y: { ticks: { color: '#9ca3af', callback: v => 'â‚©' + fmt(v) } } } }
            });
        }

        let portfolioChartInstance = null;
        function getPortfolioHTML() {
            const inv = gameState.investments;
            const assets = gameState.assets;
            const total = getTotalAssets();

            const breakdown = [
                { name: 'í˜„ê¸ˆ', value: assets.cash, color: '#10b981' },
                { name: 'ë¶€ë™ì‚°', value: assets.realEstate, color: '#3b82f6' },
                { name: 'ì£¼ì‹/ETF', value: assets.stocks, color: '#8b5cf6' },
                { name: 'ê°€ìƒìì‚°', value: assets.crypto, color: '#f59e0b' }
            ].filter(x => x.value > 0);

            let html = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4 rounded-xl">
                    <h4 class="font-bold text-yellow-400 mb-3">ğŸ“Š ìì‚° ë¹„ìœ¨</h4>
                    <canvas id="portfolioChart" height="200"></canvas>
                    <div class="mt-3 space-y-1 text-sm">
                        ${breakdown.map(b => `
                            <div class="flex justify-between">
                                <span style="color: ${b.color}">â— ${b.name}</span>
                                <span>â‚©${fmt(b.value)}ë§Œ (${total > 0 ? Math.round(b.value / total * 100) : 0}%)</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="card p-4 rounded-xl">
                    <h4 class="font-bold text-purple-400 mb-3">ğŸ’¼ ë³´ìœ  íˆ¬ì (${inv.length}ê±´) - í´ë¦­í•˜ì—¬ ì°¨íŠ¸ ë³´ê¸°</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${inv.length === 0 ? '<p class="text-gray-400 text-center py-4">ë³´ìœ ì¤‘ì¸ íˆ¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
                            inv.map((i, idx) => {
                                const currentValue = i.shares && marketPrices[i.name] ? Math.round(i.shares * marketPrices[i.name]) : i.cost;
                                const pnl = currentValue - i.cost;
                                const pnlPct = i.cost > 0 ? Math.round(pnl / i.cost * 100) : 0;
                                return `<div class="flex justify-between items-center p-2 bg-gray-700/50 rounded-lg text-sm">
                                    <div class="cursor-pointer hover:text-yellow-400" onclick="showAssetChart('${i.name}')">
                                        <span class="font-bold">${i.name}</span>
                                        ${i.shares ? `<span class="text-gray-400 ml-1">${i.shares}ì£¼</span>` : ''}
                                        <div class="text-xs text-gray-400">ë§¤ìˆ˜: â‚©${fmt(i.cost)}ë§Œ â†’ í˜„ì¬: â‚©${fmt(currentValue)}ë§Œ 
                                            <span class="${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}">(${pnl >= 0 ? '+' : ''}${pnlPct}%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${i.monthlyIncome > 0 ? `<span class="text-xs text-emerald-400">ì›” â‚©${fmt(i.monthlyIncome)}ë§Œ</span>` : ''}
                                        <button onclick="showAssetChart('${i.name}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">ğŸ“ˆ</button>
                                        <button onclick="sellInvestment(${idx})" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">ë§¤ë„</button>
                                    </div>
                                </div>`;
                            }).join('')}
                    </div>
                </div>
            </div>`;

            setTimeout(() => {
                const ctx = document.getElementById('portfolioChart');
                if (ctx && breakdown.length > 0) {
                    if (portfolioChartInstance) portfolioChartInstance.destroy();
                    portfolioChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: breakdown.map(b => b.name),
                            datasets: [{ data: breakdown.map(b => b.value), backgroundColor: breakdown.map(b => b.color), borderWidth: 0 }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: (ctx) => `â‚©${fmt(ctx.raw)}ë§Œ (${Math.round(ctx.raw / total * 100)}%)` } }
                            }
                        }
                    });
                }
            }, 100);

            return html;
        }

        function sellInvestment(idx) {
            const inv = gameState.investments[idx];

            if (inv.shares && inv.shares > 1) {
                const sharesToSell = parseInt(prompt(`${inv.name} ${inv.shares}ì£¼ ë³´ìœ ì¤‘\nëª‡ ì£¼ë¥¼ ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, inv.shares));
                if (!sharesToSell || sharesToSell <= 0) return;
                if (sharesToSell > inv.shares) { alert('ë³´ìœ  ì£¼ì‹ë³´ë‹¤ ë§ì´ ë§¤ë„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

                const currentPrice = marketPrices[inv.name] || inv.pricePerShare;
                const saleValue = Math.round(sharesToSell * currentPrice);
                const proportionalDividend = inv.monthlyIncome > 0 ? Math.round(inv.monthlyIncome * sharesToSell / inv.shares) : 0;

                if (!confirm(`${inv.name} ${sharesToSell}ì£¼ë¥¼ â‚©${fmt(saleValue)}ë§Œì›ì— ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                gameState.assets.cash += saleValue;
                gameState.assets.stocks -= Math.round(inv.cost * sharesToSell / inv.shares);
                if (proportionalDividend > 0) {
                    gameState.income.dividend -= proportionalDividend;
                    inv.monthlyIncome -= proportionalDividend;
                }

                inv.shares -= sharesToSell;
                inv.cost = Math.round(inv.cost * (inv.shares / (inv.shares + sharesToSell)));

                if (inv.shares <= 0) {
                    gameState.investments.splice(idx, 1);
                }
            } else {
                const currentValue = inv.shares && marketPrices[inv.name] ? Math.round(inv.shares * marketPrices[inv.name]) : inv.cost;
                if (!confirm(`${inv.name}ì„(ë¥¼) â‚©${fmt(currentValue)}ë§Œì›ì— ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                gameState.assets.cash += currentValue;
                gameState.assets[inv.type] -= inv.cost;
                if (inv.monthlyIncome > 0) {
                    if (inv.type === 'realEstate') gameState.income.rental -= inv.monthlyIncome;
                    else gameState.income.dividend -= inv.monthlyIncome;
                }
                gameState.investments.splice(idx, 1);
            }

            updateUI();
            showTab('portfolio');
        }

        // Save/Load
        function saveGame() {
            const saveData = {
                players,
                numPlayers,
                currentPlayer,
                turn: gameState.turn,
                marketPrices,
                priceHistory
            };
            localStorage.setItem('cashflowGame', JSON.stringify(saveData));
            alert('ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function loadGame() {
            const saved = localStorage.getItem('cashflowGame');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players || [createPlayer()];
                numPlayers = data.numPlayers || 1;
                currentPlayer = data.currentPlayer || 0;
                gameState.turn = data.turn || 1;
                if (data.marketPrices) marketPrices = data.marketPrices;
                if (data.priceHistory) priceHistory = data.priceHistory;
                updateUI();
                updateCurrentPlayerDisplay();
                alert('ê²Œì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
            }
        }

        function resetGame() {
            if (!confirm('ì •ë§ ê²Œì„ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì§„í–‰ ìƒí™©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;

            numPlayers = 1;
            currentPlayer = 0;
            players = [createPlayer()];
            gameState.turn = 1;

            marketPrices = { ...basePrices };
            priceHistory = {};
            Object.keys(marketPrices).forEach(name => {
                let history = [];
                let price = basePrices[name];
                for (let i = 0; i < 10; i++) {
                    const change = (Math.random() - 0.5) * 0.15;
                    price = Math.max(0.1, price * (1 + change));
                    history.push(Math.round(price * 100) / 100);
                }
                history.push(marketPrices[name]);
                priceHistory[name] = history;
            });

            localStorage.removeItem('cashflowGame');
            updateUI();
            updateCurrentPlayerDisplay();
            showSetupModal();
        }

        init();
    </script>
</body>

</html>
