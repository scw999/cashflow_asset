<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºì‹œí”Œë¡œìš° : íŒŒì´ë‚¸ì…œ í”„ë¦¬ë¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700&display=swap');

        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --neon-green: #10b981;
            --neon-blue: #3b82f6;
            --neon-purple: #8b5cf6;
            --neon-gold: #fbbf24;
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            color: white;
            font-family: 'Pretendard', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Card */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        /* Hover Effect Fix: No Layout Shift */
        .track-space {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .track-space:hover circle {
            stroke: white;
            stroke-width: 3px;
            filter: drop-shadow(0 0 8px var(--neon-gold));
        }
        .track-space:hover text {
            fill: white;
            font-weight: bold;
        }

        /* Token Animation */
        .token {
            transition: cx 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                        cy 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        /* Dice Rolling Animation */
        .dice-3d {
            transition: transform 0.5s;
            display: inline-block;
        }
        .rolling {
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-7xl mx-auto pb-20">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 flex items-center justify-center text-xl shadow-lg shadow-orange-500/20">ğŸ’¸</div>
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent">Financial Freedom</h1>
            </div>
            
            <div class="glass-panel px-6 py-2 rounded-full flex gap-6 text-sm md:text-base">
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-400">í„´(Turn)</span>
                    <span id="turnCount" class="font-bold text-yellow-400 text-lg">1</span>
                </div>
                <div class="w-px bg-gray-600"></div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-400">ëª©í‘œ</span>
                    <span class="font-bold text-emerald-400 text-lg">ì¥ íƒˆì¶œ</span>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="resetGame()" class="p-2 hover:bg-white/10 rounded-lg transition" title="ë¦¬ì…‹">ğŸ”„</button>
                <button onclick="showSetupModal()" class="p-2 hover:bg-white/10 rounded-lg transition" title="ì„¤ì •">âš™ï¸</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4 space-y-4">
                <div class="glass-panel rounded-2xl p-5 border-l-4 border-yellow-500">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded-full">í˜„ì¬ í”Œë ˆì´ì–´</span>
                            <h2 id="currentPlayerName" class="text-xl font-bold mt-1">í”Œë ˆì´ì–´ 1</h2>
                            <p id="currentPlayerJob" class="text-sm text-gray-300">ì§ì—…: ë¯¸ì„ íƒ</p>
                        </div>
                        <div id="currentPlayerEmoji" class="text-4xl filter drop-shadow-md">ğŸ­</div>
                    </div>
                    <div class="w-full bg-gray-700 h-2 rounded-full mt-3 overflow-hidden">
                        <div id="escapeProgress" class="h-full bg-gradient-to-r from-emerald-500 to-yellow-400 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-right text-xs text-emerald-400 mt-1">íƒˆì¶œ ì§„í–‰ë¥ </p>
                </div>

                <div class="glass-panel rounded-2xl p-5">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ“Š ì¬ë¬´ í˜„í™©</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-800/50 p-3 rounded-xl text-center">
                            <p class="text-xs text-gray-400">ì›”ê¸‰ì—¬ (ìºì‹œí”Œë¡œìš°)</p>
                            <p id="cashflow" class="text-xl font-bold text-emerald-400">â‚©0</p>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-xl text-center">
                            <p class="text-xs text-gray-400">ë³´ìœ  í˜„ê¸ˆ</p>
                            <p id="dashCash" class="text-xl font-bold text-blue-400">â‚©0</p>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm border-t border-gray-700 pt-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">ì´ ìˆ˜ì… (íŒ¨ì‹œë¸Œ)</span>
                            <span id="incPassive" class="text-emerald-400">â‚©0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ì´ ì§€ì¶œ</span>
                            <span id="expTotal" class="text-red-400">â‚©0</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="flex border-b border-gray-700">
                        <button onclick="showTab('assets')" class="tab-btn flex-1 py-3 text-sm font-bold bg-gray-800/50" data-tab="assets">ë‚´ ìì‚°</button>
                        <button onclick="showTab('market')" class="tab-btn flex-1 py-3 text-sm font-bold hover:bg-gray-700" data-tab="market">ì£¼ì‹ ì‹œì¥</button>
                    </div>
                    <div id="tabContent" class="p-4 min-h-[200px] max-h-[300px] overflow-y-auto">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-8 flex flex-col">
                <div class="glass-panel rounded-2xl p-4 md:p-8 flex-1 relative flex items-center justify-center bg-gray-900/50">
                    
                    <svg id="gameBoard" viewBox="0 0 600 600" class="w-full h-full max-h-[600px] drop-shadow-2xl">
                        <defs>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur" />
                                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                            </filter>
                        </defs>
                        </svg>

                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="pointer-events-auto text-center z-10">
                            <button id="diceBtn" onclick="rollDice()" class="group relative">
                                <div class="absolute inset-0 bg-yellow-500 rounded-2xl blur opacity-20 group-hover:opacity-40 transition"></div>
                                <div class="relative bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 p-6 rounded-2xl shadow-2xl transform transition active:scale-95 group-hover:scale-105 group-hover:border-yellow-500">
                                    <span id="dice" class="dice-3d text-6xl block mb-2">ğŸ²</span>
                                    <span class="text-sm font-bold text-yellow-400 tracking-wider">ROLL DICE</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="eventPanel" class="mt-4 glass-panel rounded-xl p-4 hidden border-l-4 border-blue-500 animate-fade-in-up">
                    <h3 id="eventTitle" class="text-xl font-bold mb-1">ì´ë²¤íŠ¸ ì œëª©</h3>
                    <p id="eventDesc" class="text-gray-300 mb-4">ì´ë²¤íŠ¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <div id="eventActions" class="flex gap-2 justify-end">
                        <button onclick="closeEvent()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-4">ğŸš€ ê²Œì„ ì‹œì‘</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">í”Œë ˆì´ì–´ ìˆ˜</label>
                    <div class="flex gap-2">
                        <button onclick="startGame(1)" class="flex-1 py-3 bg-gray-700 hover:bg-blue-600 rounded-lg transition">1ì¸</button>
                        <button onclick="startGame(2)" class="flex-1 py-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition">2ì¸</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">ë‚œì´ë„</label>
                    <div class="p-3 bg-gray-800 rounded-lg text-xs text-gray-400">
                        â€¢ ë¶€ë™ì‚°ì€ "ê¸°íšŒ" ì¹¸ì—ì„œë§Œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                        â€¢ ì£¼ì‹ì€ ì–¸ì œë“  ì‹œì¥ê°€ë¡œ ê±°ë˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                        â€¢ íŒ¨ìŠ¤íŠ¸íŠ¸ë™ ì§„ì… ì‹œ "ê¿ˆ"ì„ ì´ë¤„ì•¼ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Game Configuration & State ---
        const gameState = {
            players: [],
            currentPlayer: 0,
            turn: 1,
            marketPrices: {
                'ì‚¼ì„±ì „ì': 7, 'í…ŒìŠ¬ë¼': 25, 'ë¹„íŠ¸ì½”ì¸': 1000, 'S&P500': 5, 'ê¸ˆ': 8
            },
            priceHistory: {},
            phase: 'setup', // setup, movement, action, event
            dream: null
        };

        const tracks = {
            rat: { radius: 220, spaces: 24, color: '#3b82f6' },
            fast: { radius: 140, spaces: 12, color: '#fbbf24' }
        };

        // Improved Space Types with specific colors and icons
        const spaceTypes = [
            { type: 'payday', icon: 'ğŸ’°', color: '#10b981', label: 'ì›”ê¸‰' }, // 0
            { type: 'opportunity', icon: 'âš¡', color: '#3b82f6', label: 'ê¸°íšŒ' }, // 1 (Real Estate Here)
            { type: 'doodad', icon: 'ğŸ’¸', color: '#ef4444', label: 'ì§€ì¶œ' }, // 2
            { type: 'charity', icon: 'â¤ï¸', color: '#ec4899', label: 'ê¸°ë¶€' }, // 3
            { type: 'market', icon: 'ğŸ“ˆ', color: '#8b5cf6', label: 'ì‹œì¥' }, // 4
            { type: 'opportunity', icon: 'âš¡', color: '#3b82f6', label: 'ê¸°íšŒ' }, // 5
            { type: 'payday', icon: 'ğŸ’°', color: '#10b981', label: 'ì›”ê¸‰' }, // 6
            { type: 'baby', icon: 'ğŸ‘¶', color: '#f472b6', label: 'ì–‘ìœ¡' }, // 7
            { type: 'opportunity', icon: 'âš¡', color: '#3b82f6', label: 'ê¸°íšŒ' }, // 8
            { type: 'market', icon: 'ğŸ“‰', color: '#8b5cf6', label: 'ì‹œì¥' }, // 9
            { type: 'doodad', icon: 'ğŸ’¸', color: '#ef4444', label: 'ì§€ì¶œ' }, // 10
            { type: 'opportunity', icon: 'âš¡', color: '#3b82f6', label: 'ê¸°íšŒ' } // 11
            // ... repeated pattern for 24 spaces logic
        ];

        // Fill up to 24 spaces for Rat Race
        const ratRaceBoard = [];
        for(let i=0; i<2; i++) ratRaceBoard.push(...spaceTypes);

        const jobs = [
            { name: 'ê°œë°œì', salary: 400, cash: 1000, expenses: 250 },
            { name: 'ì˜ì‚¬', salary: 1000, cash: 3000, expenses: 600 },
            { name: 'êµì‚¬', salary: 300, cash: 500, expenses: 180 }
        ];

        // --- Core Logic ---

        function startGame(numPlayers) {
            gameState.players = [];
            for(let i=0; i<numPlayers; i++) {
                const job = jobs[Math.floor(Math.random() * jobs.length)];
                gameState.players.push({
                    id: i,
                    name: `í”Œë ˆì´ì–´ ${i+1}`,
                    job: job.name,
                    cash: job.cash,
                    salary: job.salary,
                    passiveIncome: 0,
                    expenses: job.expenses,
                    children: 0,
                    assets: { stocks: [], realEstate: [] },
                    liabilities: { loan: 0 },
                    position: 0,
                    inFastTrack: false
                });
            }
            gameState.currentPlayer = 0;
            gameState.phase = 'movement';
            document.getElementById('setupModal').classList.add('hidden');
            
            // Init Prices History
            Object.keys(gameState.marketPrices).forEach(k => {
                gameState.priceHistory[k] = [gameState.marketPrices[k]];
            });

            drawBoard();
            updateUI();
        }

        function rollDice() {
            if (gameState.phase !== 'movement') {
                alert("ì§€ê¸ˆì€ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì„¸ìš”.");
                return;
            }

            const diceBtn = document.getElementById('diceBtn');
            const diceIcon = document.getElementById('dice');
            diceIcon.classList.add('rolling');
            
            setTimeout(() => {
                diceIcon.classList.remove('rolling');
                const roll = Math.floor(Math.random() * 6) + 1;
                diceIcon.textContent = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][roll-1];
                movePlayer(roll);
            }, 600);
        }

        function movePlayer(steps) {
            const player = gameState.players[gameState.currentPlayer];
            const trackSize = player.inFastTrack ? tracks.fast.spaces : tracks.rat.spaces;
            
            // Animation loop for movement could go here, simplified for now
            player.position = (player.position + steps) % trackSize;
            
            drawBoard(); // Redraw tokens
            handleSpaceArrival(player);
        }

        function handleSpaceArrival(player) {
            gameState.phase = 'event';
            const space = ratRaceBoard[player.position]; // Assuming Rat Race for now
            
            let title = space.label;
            let desc = "";
            let actionHtml = `<button onclick="closeEvent()" class="px-4 py-2 bg-gray-600 rounded">í™•ì¸</button>`;

            // -- KEY LOGIC CHANGE: Real Estate is ONLY available here --
            if (space.type === 'opportunity') {
                // Randomly generate a deal
                const dealType = Math.random() > 0.5 ? 'small' : 'big';
                if (dealType === 'small') {
                    const cost = 5000;
                    const cashflow = 20; // Monthly return
                    title = "ğŸ¢ ì†Œí˜• ì•„íŒŒíŠ¸ ë§¤ë¬¼";
                    desc = `ê°€ê²©: â‚©${fmt(cost)}ë§Œ / ì›” ìˆ˜ìµ: â‚©${fmt(cashflow)}ë§Œ<br>êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    actionHtml = `
                        <button onclick="closeEvent()" class="px-4 py-2 bg-gray-600 rounded">íŒ¨ìŠ¤</button>
                        <button onclick="buyRealEstate('ì•„íŒŒíŠ¸', ${cost}, ${cashflow})" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded font-bold">êµ¬ë§¤</button>
                    `;
                } else {
                    title = "âš¡ ì£¼ì‹ ì‹œì¥ ì •ë³´";
                    desc = "ì‹œì¥ì˜ íë¦„ì„ ì½ì—ˆìŠµë‹ˆë‹¤. ì£¼ì‹ ê±°ë˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                    actionHtml = `<button onclick="showTab('market'); closeEvent()" class="px-4 py-2 bg-blue-600 rounded">ì‹œì¥ ë³´ê¸°</button>`;
                }
            } 
            else if (space.type === 'payday') {
                const income = (player.salary + player.passiveIncome) - player.expenses;
                player.cash += income;
                desc = `ì›”ê¸‰ë‚ ì…ë‹ˆë‹¤! ìˆœìˆ˜ìµ â‚©${fmt(income)}ë§Œì› ì§€ê¸‰ë¨.`;
            }
            else if (space.type === 'doodad') {
                const cost = Math.floor(Math.random() * 50) + 10;
                player.cash -= cost;
                desc = `ì¶©ë™êµ¬ë§¤! ìƒˆ ê°€ì „ì œí’ˆì„ ìƒ€ìŠµë‹ˆë‹¤. â‚©${fmt(cost)}ë§Œì› ì§€ì¶œ.`;
            }
            else if (space.type === 'market') {
                // Fluctuates market prices
                desc = "ì‹œì¥ ê°€ê²©ì´ ë³€ë™ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ì‹ íƒ­ì„ í™•ì¸í•˜ì„¸ìš”.";
                fluctuateMarket();
            }

            showEvent(title, desc, actionHtml);
            updateUI();
        }

        function buyRealEstate(name, cost, flow) {
            const player = gameState.players[gameState.currentPlayer];
            if (player.cash >= cost) {
                player.cash -= cost;
                player.assets.realEstate.push({ name, cost, flow });
                player.passiveIncome += flow;
                alert('êµ¬ë§¤ ì„±ê³µ!');
                closeEvent();
                updateUI();
                checkEscape(player);
            } else {
                alert('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
            }
        }

        function checkEscape(player) {
            if (!player.inFastTrack && player.passiveIncome > player.expenses) {
                alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${player.name}ë‹˜ì€ ì¥ ê²½ì£¼ë¥¼ íƒˆì¶œí–ˆìŠµë‹ˆë‹¤! íŒ¨ìŠ¤íŠ¸ íŠ¸ë™ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                player.inFastTrack = true;
                player.position = 0;
                player.cash += 10000; // Bonus
                drawBoard();
            }
        }

        function endTurn() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            if (gameState.currentPlayer === 0) gameState.turn++;
            gameState.phase = 'movement';
            updateUI();
            
            // Auto-switch back to assets tab
            showTab('assets');
            
            // Visual update for active player
            drawBoard();
        }

        function showEvent(title, desc, actions) {
            const panel = document.getElementById('eventPanel');
            document.getElementById('eventTitle').textContent = title;
            document.getElementById('eventDesc').innerHTML = desc;
            document.getElementById('eventActions').innerHTML = actions;
            panel.classList.remove('hidden');
        }

        function closeEvent() {
            document.getElementById('eventPanel').classList.add('hidden');
            endTurn();
        }

        // --- Visuals: Drawing the Board ---
        function drawBoard() {
            const svg = document.getElementById('gameBoard');
            const cx = 300, cy = 300;
            let html = '';

            // 1. Draw Tracks (Continuous Paths)
            // Fast Track (Inner)
            html += `<circle cx="${cx}" cy="${cy}" r="${tracks.fast.radius}" fill="none" stroke="rgba(251, 191, 36, 0.2)" stroke-width="40" />`;
            // Rat Race (Outer)
            html += `<circle cx="${cx}" cy="${cy}" r="${tracks.rat.radius}" fill="none" stroke="rgba(59, 130, 246, 0.1)" stroke-width="50" />`;
            
            // 2. Draw Spaces (Rat Race)
            ratRaceBoard.forEach((space, i) => {
                const angle = (i / 24) * Math.PI * 2 - Math.PI/2;
                const r = tracks.rat.radius;
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                
                // Space Circle (Background)
                html += `
                <g class="track-space" onclick="showSpaceDetail(${i})">
                    <circle cx="${x}" cy="${y}" r="20" fill="${space.color}" stroke="rgba(255,255,255,0.2)" stroke-width="2" />
                    <text x="${x}" y="${y+5}" text-anchor="middle" font-size="14">${space.icon}</text>
                </g>`;
            });

            // 3. Draw Players
            gameState.players.forEach((p, idx) => {
                const isCurrent = idx === gameState.currentPlayer;
                const track = p.inFastTrack ? tracks.fast : tracks.rat;
                const maxSpaces = p.inFastTrack ? 12 : 24;
                const angle = (p.position / maxSpaces) * Math.PI * 2 - Math.PI/2;
                
                // Offset multiple players slightly
                const offsetR = (idx - (gameState.players.length-1)/2) * 8;
                const r = track.radius + offsetR;
                
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);

                html += `
                <g class="token ${isCurrent ? 'filter drop-shadow-[0_0_8px_rgba(255,255,255,0.8)]' : ''}">
                    <circle cx="${x}" cy="${y}" r="${isCurrent ? 14 : 10}" fill="${isCurrent ? '#fff' : '#ccc'}" stroke="#000" stroke-width="2" />
                    <text x="${x}" y="${y+4}" text-anchor="middle" font-size="${isCurrent ? 12 : 8}">P${idx+1}</text>
                </g>`;
            });

            svg.innerHTML = html;
        }

        // --- UI Updates ---
        function updateUI() {
            const p = gameState.players[gameState.currentPlayer] || gameState.players[0];
            if(!p) return;

            document.getElementById('turnCount').textContent = gameState.turn;
            document.getElementById('currentPlayerName').textContent = p.name;
            document.getElementById('currentPlayerJob').textContent = `ì§ì—…: ${p.job}`;
            document.getElementById('cashflow').textContent = `â‚©${fmt(p.salary + p.passiveIncome - p.expenses)}ë§Œ`;
            document.getElementById('dashCash').textContent = `â‚©${fmt(p.cash)}ë§Œ`;
            document.getElementById('incPassive').textContent = `â‚©${fmt(p.passiveIncome)}ë§Œ`;
            document.getElementById('expTotal').textContent = `â‚©${fmt(p.expenses)}ë§Œ`;
            
            // Progress Bar
            const progress = Math.min(100, (p.passiveIncome / p.expenses) * 100);
            document.getElementById('escapeProgress').style.width = `${progress}%`;

            refreshTabContent();
        }

        function refreshTabContent() {
            const activeTabBtn = document.querySelector('.tab-btn.bg-gray-800\\/50'); // escaping slash
            const tabName = activeTabBtn ? activeTabBtn.dataset.tab : 'assets';
            const content = document.getElementById('tabContent');
            const p = gameState.players[gameState.currentPlayer];

            if (tabName === 'assets') {
                let html = '<h4 class="font-bold text-gray-400 mb-2 text-xs">ë¶€ë™ì‚°</h4>';
                if (p.assets.realEstate.length === 0) html += '<p class="text-gray-500 text-sm">ë³´ìœ  ë¶€ë™ì‚° ì—†ìŒ</p>';
                else {
                    p.assets.realEstate.forEach(a => {
                        html += `<div class="flex justify-between text-sm bg-gray-700/30 p-2 rounded mb-1">
                            <span>${a.name}</span> <span class="text-emerald-400">+â‚©${a.flow}ë§Œ/ì›”</span>
                        </div>`;
                    });
                }
                html += '<h4 class="font-bold text-gray-400 mt-4 mb-2 text-xs">ì£¼ì‹</h4>';
                // Stock logic here...
                content.innerHTML = html;

            } else if (tabName === 'market') {
                let html = '<div class="grid grid-cols-2 gap-2">';
                Object.keys(gameState.marketPrices).forEach(name => {
                    const price = gameState.marketPrices[name];
                    html += `
                    <div class="bg-gray-800 p-3 rounded-lg flex flex-col justify-between">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm">${name}</span>
                            <span class="text-xs text-blue-400">â‚©${price}ë§Œ</span>
                        </div>
                        <button onclick="buyStock('${name}')" class="w-full py-1 bg-gray-700 hover:bg-blue-600 text-xs rounded transition">ë§¤ìˆ˜í•˜ê¸°</button>
                    </div>`;
                });
                html += '</div><p class="text-xs text-gray-500 mt-2">* ë¶€ë™ì‚° ê±°ë˜ëŠ” "ê¸°íšŒ" ì¹¸ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
                content.innerHTML = html;
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('bg-gray-800/50');
                    btn.classList.remove('hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-gray-800/50');
                    btn.classList.add('hover:bg-gray-700');
                }
            });
            refreshTabContent();
        }
        
        // Helper
        function fmt(n) { return n.toLocaleString(); }
        function fluctuateMarket() {
            Object.keys(gameState.marketPrices).forEach(k => {
                const change = (Math.random() - 0.5) * 0.2; // +/- 10%
                gameState.marketPrices[k] = Math.floor(Math.max(1, gameState.marketPrices[k] * (1 + change)));
            });
        }
        function buyStock(name) {
             const p = gameState.players[gameState.currentPlayer];
             const price = gameState.marketPrices[name];
             // Simple buy logic for demo
             const qty = prompt(`${name} (â‚©${price}ë§Œ) ëª‡ ì£¼ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 10);
             if(qty && qty > 0) {
                 const total = price * qty;
                 if(p.cash >= total) {
                     p.cash -= total;
                     // Add to assets logic...
                     alert('ë§¤ìˆ˜ ì™„ë£Œ (ë¡œì§ êµ¬í˜„ í•„ìš”)');
                     updateUI();
                 } else alert('ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
             }
        }

        // Init setup
        drawBoard();
    </script>
</body>
</html>
